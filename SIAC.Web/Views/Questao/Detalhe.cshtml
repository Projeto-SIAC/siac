
@{
    ViewBag.Title = "Questão " + Model.CodQuestao;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model SIAC.Web.Models.Questao

@section Scripts {

    <script>
        $('.ui.accordion')
            .accordion()
        ;
        $('div,p')
            .popup()
        ;
        $('.button')
        .popup({
            on: 'click'
        })
        ;        
        $('a.card').click(function () {
            $card = $(this);
            src = $card.find('img').attr('src');
            legenda = $card.find('.header').text();
            fonte = $card.find('.description').text();

            $modal = $('.ui.anexo.modal');

            $modal.find('.header').text(legenda);
            $modal.find('img.image').attr('src', src);
            $modal.find('.description').html(fonte);

            $modal.modal('show');
        });
        $('.arquivar.button').click(function () {
            var _this = this;
            $(_this).addClass('loading');
            $.ajax({
                url: '/Historico/Questao/Arquivar/@Model.CodQuestao',
                type: 'POST',
                success: function (flag) {
                    if (flag) {
                        $(_this).addClass('active').text('Arquivada');
                    }
                    else {
                        $(_this).removeClass('active').text('Arquivar');
                    }
                    $(_this).removeClass('loading');
                },
                error: function () {
                    $(_this).removeClass('loading');
                }
            });
        });
    </script>
}

<h2>@ViewBag.Title</h2>

<div class="ui anexo basic modal">
    <i class="close icon"></i>
    <div class="ui centered header"></div>
    <div class="image content">
        <img class="ui centered image">
    </div>
    <div class="description" style="text-align:center;"></div>
</div>

<div class="ui segment">
    <div class="ui labels">
        <div class="ui label">
            Disciplina
            <div class="detail">
                @Model.QuestaoTema.ElementAt(0).Tema.Disciplina.Descricao
            </div>
        </div>
        <div class="ui label" data-html="@( !String.IsNullOrEmpty(Model.Dificuldade.Comentario) ? "<b>Comentário</b>: "+Model.Dificuldade.Comentario : "" )">
            Dificuldade
            <div class="detail">
                @Model.Dificuldade.Descricao
            </div>
        </div>
        @foreach (var questaoTema in Model.QuestaoTema)
        {
            <div class="ui tag label" data-html="@( !String.IsNullOrEmpty(questaoTema.Tema.Comentario) ? "<b>Comentário</b>: "+questaoTema.Tema.Comentario : "" )">@questaoTema.Tema.Descricao</div>
        }
    </div>
    <div class="ui dividing header" data-html="@( !String.IsNullOrEmpty(Model.Objetivo) ? "<b>Objetivo</b>: " + Model.Objetivo : "")">
        @{
            var enunciado = Model.Enunciado.Split('\n', '\r');
            foreach (var strEnunciado in enunciado)
            {
                if (!String.IsNullOrWhiteSpace(strEnunciado))
                {
                    <p>@strEnunciado</p>
                }
            }
        }
    </div>
    @if (Model.CodTipoQuestao == 1)
    {
        <div class="ui very relaxed list">
            @foreach (var alternativa in Model.Alternativa)
            {
                <div class="item" data-html="@(!String.IsNullOrEmpty(alternativa.Comentario) ? "<b>Comentário</b>: " + alternativa.Comentario : "")">
                        <b>@alternativa.CodOrdem.GetIndiceAlternativa()</b>) @alternativa.Enunciado
                        @if (alternativa.FlagGabarito.HasValue && alternativa.FlagGabarito.Value)
                        {
                            <a class="ui green label">Correta</a>
                        }
                </div>
            }
        </div>
    }
    else
    {
        <div data-html="@(!String.IsNullOrEmpty(Model.Comentario) ? "<b>Comentário</b>: " + Model.Comentario : "")">
            <a class="ui green ribbon label">Chave de Resposta</a>
            @{
                var chaveDeResposta = Model.ChaveDeResposta.Split('\n', '\r');
                foreach (var strChaveDeResposta in chaveDeResposta)
                {
                    if (!String.IsNullOrWhiteSpace(strChaveDeResposta))
                    {
                        <p><i>@strChaveDeResposta</i></p>
                    }
                }
            }
        </div>
    }
    @if (Model.QuestaoAnexo.Count > 0)
    {
        <br />
        <div class="ui styled fluid accordion">
            <div class="title"><i class="icon dropdown"></i>Anexos</div>
            <div class="content">
                @foreach (var anexo in Model.QuestaoAnexo)
                {
                    switch (anexo.CodTipoAnexo)
                    {
                        case 1:
                            <a class="ui card">
                                <div class="image">
                                    <img src="data:image/png;base64,@Convert.ToBase64String(anexo.Anexo,0, anexo.Anexo.Length)" />
                                </div>
                                <div class="content">
                                    <div class="header">
                                        @anexo.Legenda
                                    </div>
                                    <div class="description">
                                        @(!String.IsNullOrEmpty(anexo.Fonte) ? anexo.Fonte : "Fonte não informada")
                                    </div>
                                </div> 
                            </a>
                            break;
                        default:
                            break;
                    }
                }
            </div>
        </div>
    }
</div>
@{ 
    var lstResposta = Model.Resposta().Where(r=>!String.IsNullOrWhiteSpace(r.RespComentario)).ToList();
}
@if(lstResposta.Count > 0) { 
<div class="ui secondary segment">
    <div class="ui dividing header">
        <p>Comentários</p>
    </div>
    @* Expor comentários dos usuários que já responderam essa questão *@
    <div class="ui comments" style="max-height: 15em; overflow-y:auto">
        @foreach (var resp in lstResposta)
        {            
            <div class="comment">
                <div class="content">
                    <a class="author">@resp.PessoaFisica.Nome.Split(' ')[0]</a>
                    <div class="metadata">
                        <span class="date">@resp.AvalTemaQuestao.AvaliacaoTema.Avaliacao.DtCadastro.ToElapsedTimeString()</span>@* Continuar: pegar data da AvalPessoaResultado *@
                    </div>
                    <div class="text">
                        @{
                            var comentario = resp.RespComentario.Split('\n', '\r');
                            foreach (var strComentario in comentario)
                            {
                                if (!String.IsNullOrWhiteSpace(strComentario))
                                {
                                    <p>@strComentario</p>
                                }
                            }
                        }
                    </div>
                </div>
            </div>            
        }
    </div>
</div>
                            }

<div class="ui arquivar toggle @(Model.FlagArquivo ? "active":"") button">
    Arquiva@(Model.FlagArquivo ? "da":"r")
</div>
<a href="/Historico/Questao/Editar/@Model.CodQuestao" class="ui button">
    Editar
</a>